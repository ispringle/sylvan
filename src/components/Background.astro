---
---
<canvas id="background-canvas" style="display:none;"></canvas>
<script>
function hexToRGB(hexcode) {
  const [,hexR, hexG, hexB] = hexcode.match(/#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})/)
  const r = parseInt(hexR, 16)
  const g = parseInt(hexG, 16)
  const b = parseInt(hexB, 16)
  return [ r, g, b]
}
function bayer(image, depth, colorOne, colorTwo) {
    const thresholdMap = [
      [0, 8, 2, 10],
      [12, 4, 14, 6],
      [3, 11, 1, 9],
      [15, 7, 13, 5],
    ]
  const mapSize = thresholdMap.length

  const { data, height, width } = image
  for (let i = 0; i < data.length; i += 4) {
    const x = i / 4 % width;
    const y = Math.floor(i / 4 / width);

    const lumen = (data[i] * 0.299) + (data[i+1] * 0.587) + (data[i+2] * 0.114);
    const map = Math.floor((lumen + thresholdMap[x % mapSize][y % mapSize]) / 2);
    const value = map > depth ? colorOne : colorTwo;
    for (let c = 0; c < value.length; c++) {
        data[i+c] = value[c]
      }
  }

  return image
}

const canvas = document.getElementById("background-canvas");
const ctx = canvas.getContext("2d");
ctx.canvas.width = window.innerWidth;
ctx.canvas.height = window.innerHeight;

// Setup intermediate canvas with gradient
const intermediateCanvas = document.createElement('canvas');
const intermediateContext = intermediateCanvas.getContext('2d');

intermediateContext.canvas.width = window.innerWidth;
intermediateContext.canvas.height = window.innerHeight;

let gradient = intermediateContext.createLinearGradient(0, canvas.width, 0, 0)
gradient.addColorStop(0, "black")
gradient.addColorStop(1, "white")

intermediateContext.fillStyle = gradient;
intermediateContext.fillRect(0, 0, canvas.width, canvas.height);

const intermediateImageData = intermediateContext.getImageData(0, 0, canvas.width, canvas.height)

// Blit intermediate canvas to background-canvas
ctx.putImageData(bayer(intermediateImageData, 80, hexToRGB("#2b59c3"), hexToRGB("#e9aaa9")), 0, 0);

document.body.style.background = "url(" + canvas.toDataURL() + ")";
document.body.style.backgroundAttachment = "fixed";
</script>
